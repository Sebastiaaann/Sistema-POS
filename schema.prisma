// ============================================
// SCHEMA PRISMA - Sistema de Stock SaaS
// VERSIÓN: Sprint 1 - Con Terceros, Almacenes y Stock Multi-ubicación
// ============================================

generator client {
  provider = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
  extensions = [pgcrypto, uuid_ossp]
}

// ============================================
// SISTEMA DE IDENTIDAD GLOBAL (Auth.js)
// ============================================

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String    @unique
  emailVerified DateTime?
  image         String?
  password      String?

  accounts    Account[]
  sessions    Session[]
  membresias  Miembro[]
  movimientos MovimientoStock[]

  deletedAt DateTime?
  isActive  Boolean   @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("users")
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id                   String   @id @default(cuid())
  sessionToken         String   @unique
  userId               String
  expires              DateTime
  activeOrganizationId String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

// ============================================
// SISTEMA DE MULTI-TENANCY (Organización)
// ============================================

model Organizacion {
  id      String  @id @default(cuid())
  nombre  String
  slug    String  @unique
  urlLogo String?
  colores Json?

  // FEATURE GATING
  plan PlanSuscripcion @default(BASICO)

  // CONFIGURACIÓN DE NEGOCIO
  moneda                String  @default("CLP")
  formatoFecha          String  @default("DD/MM/YYYY")
  permitirStockNegativo Boolean @default(true)
  alertaStockBajo       Int     @default(10)
  ventaSinStock         Boolean @default(false)

  deletedAt DateTime?
  isActive  Boolean   @default(true)

  fechaCreacion      DateTime @default(now())
  fechaActualizacion DateTime @updatedAt

  // Relaciones
  miembros        Miembro[]
  categorias      Categoria[]
  productos       Producto[]
  movimientos     MovimientoStock[]
  terceros        Tercero[]
  almacenes       Almacen[]
  stockPorAlmacen StockPorAlmacen[]

  @@index([nombre])
  @@index([plan])
  @@map("organizaciones")
}

model Miembro {
  id  String     @id @default(cuid())
  rol RolUsuario @default(VENDEDOR)

  userId         String
  organizacionId String

  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  organizacion Organizacion @relation(fields: [organizacionId], references: [id], onDelete: Cascade)

  fechaCreacion DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@unique([userId, organizacionId])
  @@index([userId])
  @@index([organizacionId])
  @@map("miembros")
}

// ============================================
// DATOS DEL NEGOCIO (Aislados por Organización)
// ============================================

model Categoria {
  id                 String   @id @default(cuid())
  nombre             String
  descripcion        String?
  organizacionId     String
  activo             Boolean  @default(true)
  fechaCreacion      DateTime @default(now())
  fechaActualizacion DateTime @updatedAt

  organizacion Organizacion @relation(fields: [organizacionId], references: [id], onDelete: Cascade)
  productos    Producto[]

  @@index([organizacionId])
  @@map("categorias")
}

// ============================================
// NUEVO: Tercero (Proveedores y Clientes)
// ============================================
model Tercero {
  id                 String      @id @default(cuid())
  tipo               TipoTercero
  nombre             String
  rut                String?
  email              String?
  telefono           String?
  direccion          String?
  ciudad             String?
  pais               String?     @default("Chile")
  notas              String?
  organizacionId     String
  activo             Boolean     @default(true)
  fechaCreacion      DateTime    @default(now())
  fechaActualizacion DateTime    @updatedAt

  organizacion Organizacion      @relation(fields: [organizacionId], references: [id], onDelete: Cascade)
  movimientos  MovimientoStock[]

  @@unique([rut, organizacionId])
  @@index([organizacionId])
  @@index([tipo])
  @@map("terceros")
}

// ============================================
// NUEVO: Almacén (Bodegas/Ubicaciones)
// ============================================
model Almacen {
  id                 String   @id @default(cuid())
  nombre             String
  codigo             String
  direccion          String?
  ciudad             String?
  responsable        String?
  esPrincipal        Boolean  @default(false)
  organizacionId     String
  activo             Boolean  @default(true)
  fechaCreacion      DateTime @default(now())
  fechaActualizacion DateTime @updatedAt

  organizacion    Organizacion      @relation(fields: [organizacionId], references: [id], onDelete: Cascade)
  stockPorAlmacen StockPorAlmacen[]
  movimientos     MovimientoStock[]

  @@unique([codigo, organizacionId])
  @@index([organizacionId])
  @@map("almacenes")
}

// ============================================
// NUEVO: Stock por Almacén
// ============================================
model StockPorAlmacen {
  id                 String   @id @default(cuid())
  productoId         String
  almacenId          String
  stockActual        Int      @default(0)
  stockMinimo        Int      @default(0)
  organizacionId     String
  fechaActualizacion DateTime @updatedAt

  producto     Producto     @relation(fields: [productoId], references: [id], onDelete: Cascade)
  almacen      Almacen      @relation(fields: [almacenId], references: [id], onDelete: Cascade)
  organizacion Organizacion @relation(fields: [organizacionId], references: [id], onDelete: Cascade)

  @@unique([productoId, almacenId])
  @@index([organizacionId])
  @@index([productoId])
  @@index([almacenId])
  @@map("stock_por_almacen")
}

model Producto {
  id           String  @id @default(cuid())
  nombre       String
  sku          String
  codigoBarras String?
  descripcion  String?
  unidadMedida String  @default("UND")

  precioVenta Decimal @db.Decimal(12, 4)
  precioCosto Decimal @db.Decimal(12, 4)

  // NOTA: stockActual se mantiene para compatibilidad, pero se usará stockPorAlmacen
  stockActual Int @default(0)

  imagenUrl      String?
  organizacionId String
  categoriaId    String?

  deletedAt DateTime?
  isActive  Boolean   @default(true)

  fechaCreacion      DateTime @default(now())
  fechaActualizacion DateTime @updatedAt

  categoria       Categoria?        @relation(fields: [categoriaId], references: [id], onDelete: SetNull)
  organizacion    Organizacion      @relation(fields: [organizacionId], references: [id], onDelete: Cascade)
  movimientos     MovimientoStock[]
  stockPorAlmacen StockPorAlmacen[]

  @@unique([id, organizacionId])
  @@index([organizacionId, nombre])
  @@index([organizacionId, categoriaId])
  @@index([organizacionId, deletedAt])
  @@index([codigoBarras])
  @@map("productos")
}

model MovimientoStock {
  id              String         @id @default(cuid())
  tipo            TipoMovimiento
  cantidad        Int
  motivo          String?        @db.VarChar(255)
  numeroDocumento String?
  fecha           DateTime       @default(now())

  // Snapshots financieros
  precioUnitarioSnapshot Decimal? @db.Decimal(12, 4)
  costoUnitarioSnapshot  Decimal? @db.Decimal(12, 4)
  valorTotal             Decimal? @default(dbgenerated()) @db.Decimal(14, 4)

  productoId     String
  creadoPorId    String
  terceroId      String?
  almacenId      String?
  organizacionId String

  producto     Producto     @relation(fields: [productoId], references: [id], onDelete: Restrict)
  creadoPor    User         @relation(fields: [creadoPorId], references: [id], onDelete: Restrict)
  tercero      Tercero?     @relation(fields: [terceroId], references: [id], onDelete: SetNull)
  almacen      Almacen?     @relation(fields: [almacenId], references: [id], onDelete: Restrict)
  organizacion Organizacion @relation(fields: [organizacionId], references: [id], onDelete: Cascade)

  @@index([organizacionId, fecha])
  @@index([productoId, fecha])
  @@index([creadoPorId])
  @@index([organizacionId, tipo, fecha])
  @@index([terceroId])
  @@index([almacenId])
  @@map("movimientos_stock")
}

// ============================================
// ENUMS
// ============================================

enum RolUsuario {
  ADMIN
  VENDEDOR
}

enum TipoMovimiento {
  ENTRADA
  SALIDA
  AJUSTE_POSITIVO
  AJUSTE_NEGATIVO
}

enum PlanSuscripcion {
  BASICO
  PRO
  ENTERPRISE
}

enum TipoTercero {
  PROVEEDOR
  CLIENTE
  AMBOS
}
